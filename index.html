const TelegramBot = require("node-telegram-bot-api");
const fs = require("fs");
const config = require("./config");

const bot = new TelegramBot(config.BOT_TOKEN, { polling: true });
let db = JSON.parse(fs.readFileSync("database.json"));

function saveDB() {
  fs.writeFileSync("database.json", JSON.stringify(db, null, 2));
}

// ØªØ­Ù‚Ù‚ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ Ø¨Ù‚Ù†Ø§Ø© ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…
async function checkTelegramJoin(userId) {
  try {
    const member = await bot.getChatMember(config.TELEGRAM_CHANNEL, userId);
    return ["member", "administrator", "creator"].includes(member.status);
  } catch {
    return false;
  }
}

// /start
bot.onText(/\/start/, (msg) => {
  const id = msg.from.id;

  if (!db.users[id]) {
    db.users[id] = {
      points: 0,
      tasks: {
        telegram: false,
        twitter: false,
        youtube: false
      }
    };
    saveDB();
  }

  bot.sendMessage(
    id,
    "ğŸ›ï¸ Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ *AGE Airdrop Game*\n\nÙ†ÙÙ‘Ø° Ø§Ù„Ù…Ù‡Ø§Ù…ØŒ Ø§Ø¬Ù…Ø¹ Ù†Ù‚Ø§Ø·ØŒ ÙˆØ§Ø­ØµÙ„ Ø¹Ù„Ù‰ ØªÙˆÙƒÙ†Ø§Øª AGE ğŸ–ï¸",
    {
      parse_mode: "Markdown",
      reply_markup: {
        inline_keyboard: [
          [{ text: "ğŸ“‹ Ø§Ù„Ù…Ù‡Ø§Ù…", callback_data: "tasks" }],
          [{ text: "â­ Ù†Ù‚Ø§Ø·ÙŠ", callback_data: "points" }],
          [{ text: "ğŸ† Ø§Ù„ØªØ±ØªÙŠØ¨", callback_data: "leaderboard" }]
        ]
      }
    }
  );
});

// Ø§Ù„Ø£Ø²Ø±Ø§Ø±
bot.on("callback_query", async (q) => {
  const id = q.from.id;
  const user = db.users[id];
  if (!user) return;

  // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù‡Ø§Ù…
  if (q.data === "tasks") {
    bot.sendMessage(id, "ğŸ“Œ Ù…Ù‡Ø§Ù… AGE Ø§Ù„Ù…ØªØ§Ø­Ø©:", {
      reply_markup: {
        inline_keyboard: [
          [
            { text: "ğŸ“¢ Ø§Ø´ØªØ±Ùƒ Ø¨Ù‚Ù†Ø§Ø© ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù… (+20)", url: "https://t.me/AGEGOLD" },
            { text: "âœ… ØªØ­Ù‚Ù‚", callback_data: "task_telegram" }
          ],
          [
            { text: "ğŸ¦ ØªØ§Ø¨Ø¹Ù†Ø§ Ø¹Ù„Ù‰ X (+30)", url: "https://x.com/ktr_2008" },
            { text: "âœ… ØªØ­Ù‚Ù‚", callback_data: "task_twitter" }
          ],
          [
            { text: "ğŸ“º Ø§Ø´ØªØ±Ùƒ YouTube (+30)", url: "https://www.youtube.com/@AGECOIN" },
            { text: "âœ… ØªØ­Ù‚Ù‚", callback_data: "task_youtube" }
          ]
        ]
      }
    });
  }

  // Ù†Ù‚Ø§Ø·ÙŠ
  if (q.data === "points") {
    bot.sendMessage(id, `â­ Ù†Ù‚Ø§Ø·Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠØ©: *${user.points}*`, {
      parse_mode: "Markdown"
    });
  }

  // Ø§Ù„ØªØ±ØªÙŠØ¨
  if (q.data === "leaderboard") {
    const top = Object.entries(db.users)
      .sort((a, b) => b[1].points - a[1].points)
      .slice(0, 10);

    let text = "ğŸ† *Ø£ÙØ¶Ù„ 10 Ù„Ø§Ø¹Ø¨ÙŠÙ†:*\n\n";
    top.forEach((u, i) => {
      text += `${i + 1}. ID: ${u[0]} â€” ${u[1].points} Ù†Ù‚Ø·Ø©\n`;
    });

    bot.sendMessage(id, text, { parse_mode: "Markdown" });
  }

  // Ù…Ù‡Ù…Ø© ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù… (ØªØ­Ù‚Ù‚ Ø­Ù‚ÙŠÙ‚ÙŠ)
  if (q.data === "task_telegram") {
    if (user.tasks.telegram) {
      return bot.answerCallbackQuery(q.id, {
        text: "âŒ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù‡Ù…Ø© Ù…ÙƒØªÙ…Ù„Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹",
        show_alert: true
      });
    }

    const joined = await checkTelegramJoin(id);
    if (!joined) {
      return bot.answerCallbackQuery(q.id, {
        text: "âš ï¸ Ù„Ø§Ø²Ù… ØªØ´ØªØ±Ùƒ Ø¨Ø§Ù„Ù‚Ù†Ø§Ø© Ø£ÙˆÙ„Ø§Ù‹",
        show_alert: true
      });
    }

    user.tasks.telegram = true;
    user.points += 20;
    saveDB();

    return bot.answerCallbackQuery(q.id, {
      text: "âœ… ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ +20 Ù†Ù‚Ø·Ø©",
      show_alert: true
    });
  }

  // Ù…Ù‡Ù…Ø© X
  if (q.data === "task_twitter") {
    if (user.tasks.twitter) {
      return bot.answerCallbackQuery(q.id, {
        text: "âŒ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù‡Ù…Ø© Ù…ÙƒØªÙ…Ù„Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹",
        show_alert: true
      });
    }

    user.tasks.twitter = true;
    user.points += 30;
    saveDB();

    return bot.answerCallbackQuery(q.id, {
      text: "âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© +30 Ù†Ù‚Ø·Ø©",
      show_alert: true
    });
  }

  // Ù…Ù‡Ù…Ø© YouTube
  if (q.data === "task_youtube") {
    if (user.tasks.youtube) {
      return bot.answerCallbackQuery(q.id, {
        text: "âŒ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù‡Ù…Ø© Ù…ÙƒØªÙ…Ù„Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹",
        show_alert: true
      });
    }

    user.tasks.youtube = true;
    user.points += 30;
    saveDB();

    return bot.answerCallbackQuery(q.id, {
      text: "âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ +30 Ù†Ù‚Ø·Ø©",
      show_alert: true
    });
  }
});
