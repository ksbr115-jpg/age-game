<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AGE GOLD - Official System</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    <style>
        :root { --gold: #f1c40f; --bg: #000; --card: #111; --gray: #333; --red: #e74c3c; }
        body { background: var(--bg); color: #fff; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; overflow-x: hidden; touch-action: manipulation; }
        
        .container { padding: 70px 15px 100px; text-align: center; }
        .hero { background: linear-gradient(180deg, #151515, #000); border: 1px solid #222; border-radius: 20px; padding: 30px 15px; margin-bottom: 20px; }
        .hero h1 { font-size: 50px; color: var(--gold); margin: 0; }
        
        .section { display: none; animation: fadeIn 0.3s; }
        .section.active { display: block; }

        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨ */
        #game-area { background: #080808; border-radius: 15px; border: 1px solid #222; overflow: hidden; position: relative; margin-top: 15px; height: 320px; }
        canvas { display: block; background: #050505; width: 100%; height: 100%; touch-action: none; }
        .game-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(0,0,0,0.7); z-index: 10; }

        .controls-row { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #111; border-radius: 15px; margin-top: 10px; }
        .btn-ctrl { background: #333; color: white; border: 2px solid var(--gold); width: 60px; height: 60px; border-radius: 50%; font-size: 24px; display: flex; align-items: center; justify-content: center; }

        /* Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¹Ø§Ù… */
        .task-card { background: var(--card); border: 1px solid #222; border-radius: 15px; padding: 15px; margin-bottom: 12px; text-align: right; }
        .days-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 15px; }
        .day-card { background: var(--card); border: 1px solid #222; padding: 15px; border-radius: 12px; }
        .btn-claim { background: var(--gold); color: #000; border: none; padding: 8px; border-radius: 6px; font-weight: bold; width: 100%; margin-top: 8px; cursor: pointer; }
        
        /* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ† */
        .leader-item { display: flex; justify-content: space-between; background: #111; padding: 12px; margin-bottom: 5px; border-radius: 8px; border-right: 4px solid var(--gold); }
        .leader-item.me { background: #222; border-right-color: #fff; }

        .nav-bar { position: fixed; bottom: 0; width: 100%; background: #080808; border-top: 1px solid #222; display: flex; height: 75px; z-index: 1000; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 9px; color: #555; border: none; background: none; gap: 5px; cursor: pointer; }
        .nav-item.active { color: var(--gold); border-top: 2px solid var(--gold); }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <div class="container">
        <div class="hero">
            <h1 id="user-pts">0</h1>
            <p id="user-name" style="color:#888;">@You</p>
        </div>

        <div id="tab1" class="section active">
            <div class="task-btns" style="margin-bottom:10px;">
                <button class="btn-act btn-go" onclick="setGame('knives')">âš”ï¸ Ø³ÙƒØ§ÙƒÙŠÙ†</button>
                <button class="btn-act btn-go" onclick="setGame('platform')">ğŸƒ Ø­Ø±ÙƒØ©</button>
            </div>
            <div id="game-area">
                <canvas id="gameCanvas"></canvas>
                <div id="game-ui" class="game-overlay">
                    <button class="btn-link" style="padding:15px 30px; font-size:16px; background:var(--gold); border-radius:10px; border:none; font-weight:bold;" onclick="startGame()">Ø¥Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨ ğŸ®</button>
                </div>
            </div>
            <div id="platform-ctrls" class="controls-row" style="display:none;">
                <button class="btn-ctrl" onpointerdown="move(-1)" onpointerup="stopMove()">â¬…ï¸</button>
                <button class="btn-ctrl" onpointerdown="jump()" style="background:var(--gold); color:#000;">â¬†ï¸</button>
                <button class="btn-ctrl" onpointerdown="move(1)" onpointerup="stopMove()">â¡ï¸</button>
            </div>
        </div>

        <div id="tab3" class="section">
            <h3 class="list-title">Ù…Ù‡Ø§Ù… 7 Ø£ÙŠØ§Ù… ğŸ“…</h3>
            <div class="days-grid" id="days-container"></div>
        </div>

        <div id="tab5" class="section">
            <div class="task-btns" style="margin-bottom:15px;">
                <button class="btn-act btn-go" onclick="renderLeaderboard('points')">ğŸ† Ø§Ù„Ù†Ù‚Ø§Ø·</button>
                <button class="btn-act btn-go" onclick="renderLeaderboard('refs')">ğŸ”— Ø§Ù„Ø¥Ø­Ø§Ù„Ø§Øª</button>
            </div>
            <div id="leader-list"></div>
        </div>

        <div id="tab2" class="section"><div id="social-tasks"></div></div>
        <div id="tab4" class="section">
            <div class="task-card" style="text-align:center;">
                <input type="text" id="ref-link-val" readonly style="width:90%; background:#000; color:var(--gold); padding:10px; border:1px solid #222;">
                <button class="btn-act btn-go" onclick="copyRef()" style="margin-top:10px;">Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·</button>
            </div>
        </div>
    </div>

    <nav class="nav-bar">
        <button class="nav-item active" onclick="showTab(1, this)">ğŸ <br>Ø±Ø¦ÙŠØ³ÙŠØ©</button>
        <button class="nav-item" onclick="showTab(2, this)">ğŸ¯<br>Ù…Ù‡Ø§Ù…</button>
        <button class="nav-item" onclick="showTab(3, this)">âš¡<br>Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©</button>
        <button class="nav-item" onclick="showTab(4, this)">ğŸ”—<br>Ø§Ù„Ø¥Ø­Ø§Ù„Ø©</button>
        <button class="nav-item" onclick="showTab(5, this)">ğŸ†<br>Ø§Ù„Ù†Ù‚Ø§Ø·</button>
    </nav>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDt6tmNq_On6_wnCbQdqmiMcNkgZAxGZPo",
            databaseURL: "https://age-game-d193d-default-rtdb.firebaseio.com",
            projectId: "age-game-d193d",
            appId: "1:1086396979239:web:6652b5bebee7f5126c1602"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const params = new URLSearchParams(window.location.search);
        let uid = params.get('id') || localStorage.getItem('age_uid') || "U"+Math.floor(Math.random()*9999);
        localStorage.setItem('age_uid', uid);

        let activeGame = 'knives';
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let gameActive = false, player = { x: 50, y: 200, w: 30, h: 30, dy: 0 }, enemies = [], coins = [], moveDir = 0;

        function setGame(m) { 
            activeGame = m; 
            document.getElementById('platform-ctrls').style.display = (m==='platform'?'flex':'none');
            gameActive = false; 
            document.getElementById('game-ui').style.display='flex';
        }

        function startGame() {
            canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight;
            gameActive = true; enemies = []; coins = []; player = { x: 50, y: 200, w: 30, h: 30, dy: 0, grounded: false };
            document.getElementById('game-ui').style.display = 'none';
            if(activeGame === 'platform') generateLevel();
            loop();
        }

        function generateLevel() {
            for(let i=0; i<5; i++) coins.push({x: 100+i*80, y: 150, v: true});
        }

        function loop() {
            if(!gameActive) return;
            ctx.clearRect(0,0, canvas.width, canvas.height);
            if(activeGame === 'knives') {
                // Ù…Ù†Ø·Ù‚ Ø§Ù„Ø³ÙƒØ§ÙƒÙŠÙ† (ÙƒÙˆØ¯Ùƒ Ø§Ù„Ø£ØµÙ„ÙŠ Ù…Ø¹ ØªØ­Ø³ÙŠÙ†)
                ctx.fillStyle = "red";
                if(Math.random() < 0.02) enemies.push({x: Math.random()*canvas.width, y: 0});
                enemies.forEach((en, i) => {
                    en.y += 2; ctx.fillRect(en.x, en.y, 30, 20);
                    if(en.y > canvas.height) gameActive = false;
                });
            } else {
                // Ù…Ù†Ø·Ù‚ Ø§Ù„Ø­Ø±ÙƒØ©
                player.x += moveDir * 4; player.dy += 0.8; player.y += player.dy;
                if(player.y > 250) { player.y = 250; player.dy = 0; player.grounded = true; }
                ctx.fillStyle = "gold";
                coins.forEach(c => { if(c.v) { ctx.fillText("ğŸª™", c.x, c.y); if(Math.abs(player.x-c.x)<20) { c.v=false; addPoints(1); } } });
                ctx.fillStyle = "#00f"; ctx.fillRect(player.x, player.y, player.w, player.h);
            }
            requestAnimationFrame(loop);
        }

        function move(d) { moveDir = d; }
        function stopMove() { moveDir = 0; }
        function jump() { if(player.grounded) { player.dy = -12; player.grounded = false; } }

        function addPoints(p) { db.ref(`players/${uid}/points`).transaction(c => (c||0)+p); }

        // --- Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ† ---
        function renderLeaderboard(type) {
            db.ref('players').orderByChild(type === 'points' ? 'points' : 'refCount').limitToLast(10).once('value', s => {
                let list = [];
                s.forEach(child => { list.push({id: child.key, ...child.val()}); });
                list.reverse();
                let html = '';
                list.forEach((u, i) => {
                    let isMe = u.id === uid;
                    html += `<div class="leader-item ${isMe?'me':''}">
                        <span>#${i+1} ${isMe ? 'You' : (u.username || 'Ù„Ø§Ø¹Ø¨')}</span>
                        <span>${(type==='points' ? u.points : u.refCount) || 0}</span>
                    </div>`;
                });
                document.getElementById('leader-list').innerHTML = html;
            });
        }

        // --- Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ© ---
        function renderWeekly() {
            let prog = JSON.parse(localStorage.getItem('week_prog')) || {last: 0, day: 1};
            let now = Date.now();
            let html = '';
            for(let i=1; i<=7; i++) {
                let canClaim = (i === prog.day && now - prog.last > 86400000);
                if(i === prog.day && prog.last === 0) canClaim = true;
                html += `<div class="day-card" style="border: 1px solid ${i<=prog.day?'var(--gold)':'#222'}">
                     Ø§Ù„ÙŠÙˆÙ… ${i} <br> ğŸ’° ${i*100}
                    <button class="btn-claim" ${!canClaim?'disabled style="opacity:0.5"':''} onclick="claimDay(${i})">${i<prog.day?'âœ…':'Ø§Ø³ØªÙ„Ø§Ù…'}</button>
                </div>`;
            }
            document.getElementById('days-container').innerHTML = html;
        }

        function claimDay(d) {
            addPoints(d*100);
            localStorage.setItem('week_prog', JSON.stringify({last: Date.now(), day: d+1}));
            renderWeekly();
        }

        function showTab(t, el) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.getElementById('tab'+t).classList.add('active');
            el.classList.add('active');
            if(t === 5) renderLeaderboard('points');
            if(t === 3) renderWeekly();
        }

        db.ref('players/'+uid+'/points').on('value', s => { document.getElementById('user-pts').innerText = (s.val()||0).toLocaleString(); });
        
        canvas.addEventListener('touchstart', (e) => {
            if(activeGame === 'knives' && gameActive) {
                const rect = canvas.getBoundingClientRect();
                let kX = e.touches[0].clientX - rect.left;
                enemies.forEach((en, i) => { if(Math.abs(en.x - kX) < 40) { enemies.splice(i,1); addPoints(5); } });
            }
        });

        renderWeekly();
    </script>
</body>
</html>
